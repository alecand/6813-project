<!DOCTYPE html>

<!--
  Alec Anderson, Alex Latham, Emanuele Ceccarelli, Vineel Chakradhar (listed reluctantly)
-->
<html>

<head>
<meta charset="UTF-8">
<title>eFormations</title>

<!-- Load style sheets -->
<link rel="stylesheet" href="mainLayout.css" />
</head>

<body>

<!-- TODO we could do this using divs if the exact pixel spacing is an issue...-->
<table id="mainTable">
    <table id="mainMenu">
        <div height='400px' id="ediv" align="center">
        Menu is here
        </div>
    </table>
    <table id="middle">
        <tr>
            <td id="formationWindow">
                formation sidebar here
            </td>
            <td id="centerWindow">
                <tr id="dancerWindow"> 
                    Main center window is here
                </tr>
                <tr id="centerNotesWindow">
                    Notes here
                </tr>
            </td>
            <td id="rosterWindow">
                roster window here
            </td>
        </tr>
    </table>
    <table id="musicWindow">
        Music window here
    </table>

</table>


<!-- Load any supplemental Javascript libraries here -->
<script type="text/javascript" src="external_js/jquery-1.9.0.min.js"></script>
<script type="text/javascript" src="checker.js"></script>
<script type="text/javascript" src="boardEvent.js"></script>
<script type="text/javascript" src="board.js"></script>
<script type="text/javascript" src="rules.js"></script>

<script type="text/javascript">
//This script extracts parameters from the URL
//from jquery-howto.blogspot.com
    $.extend({
        getUrlVars : function() {
            var vars = [], hash;
            var hashes = window.location.href.slice(
                    window.location.href.indexOf('?') + 1).split('&');
            for ( var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        },
        getUrlVar : function(name) {
            return $.getUrlVars()[name];
        }
    });

    var DEFAULT_BOARD_SIZE = 8;
    // My code below
    var turn = false; // true means black, false means red
    var allCheckers = -1;
    var last_center = -1;
    var current_center = -1;
    var row = 'none';
    var column = 'none'
    // End my code

    //data model
    var board;
    var rules;
    var whoseTurn = "black";    

    var directionOf = function(color) {
      if (color == "black") {
        return -1;
      }
      return 1;
    }

    // Fill in this function to toggle the display for whose turn
    // The color parameter should be either "black" or "red"
    var toggleTurn = function(color) {
        // Your code here
        // MY CODE BELOW
        if (turn) {
            $('#turnIndicator').css('background-color','black')
            $('#turnIndicator').text("Black's turn");
            $('#turnIndicator').css('color', 'white');
            turn = false;
            whoseTurn = 'black';
        }
        else {
            $('#turnIndicator').css('background-color', 'red')
            $('#turnIndicator').text("Red's turn");
            $('#turnIndicator').css('color', 'black');
            turn = true;
            whoseTurn = 'red';
        }
        populateBoard();

    }

    // MY CODE BELOW

    function populateBoard() {
        // Enable Undo button only if possible
        if (rules.ramStack.length > 0) {
            document.getElementById("btnUndo").disabled = false;
        }
        else {
            document.getElementById("btnUndo").disabled = true;
        }
        // Enable Redo button only if possible
        if (rules.redoStack.length > 0) {
            document.getElementById("btnRedo").disabled = false;
        }
        else {
            document.getElementById("btnRedo").disabled = true;
        }        


        checkers = board.getAllCheckers();

        $('#checkerboard tbody').remove();
        $('#checkerboard').append('<tbody> </tbody>')
        var size = 400/board.boardSize;
        // var size = 13;
        var for_id = 'none';
        for (i=0; i < board.boardSize; i++) { // i loop is through columns
            var for_row = '<tr class="board_row"'.concat('style = "height: ', size).concat('px; ', '">');
            for (j=0; j<board.boardSize; j++) { // j loop is through rows
                for (k=0; k < checkers.length; k++) { // k loop is through checkers
                    // Construct class
                    if (i%2 == 0) {
                        var for_class = "square".concat(j%2);  
                    }
                    else {
                        var integer = (j%2 + 1)%2
                        var for_class = "square".concat(integer);
                    }
                    // Populate from checker
                    if (checkers[k].col == j && checkers[k].row == i) {
                        if (checkers[k].isKing) {
                            for_id = checkers[k].color.concat('king');
                        }
                        else {
                            for_id = checkers[k].color;
                        }
                    }
                }
                // Grey box edit
                for_id = for_id.concat('row',i,'col',j);
                var for_row = for_row.concat('<td class= ', for_class, ' id =', for_id, '> </td>');
                for_id = 'none';
            }
            $('#checkerboard tbody').append(for_row.concat('</tr>'));
        }

        /////// Add the checker images /////////////////

        // Add the red and black pieces
        function addPieces(pieces, color) {
            var img = document.createElement('img')
            var king_img = document.createElement('img')
            img.className = 'checker_image';
            king_img.className = 'checker_image'
            if (color == 'black') {
                img.src = 'graphics/black-piece.png';
                king_img.src = 'graphics/black-king.png';
            }
            else if (color == 'red') {
                img.src = 'graphics/red-piece.png';
                king_img.src = 'graphics/red-king.png';
            }
            img.height = 400/board.boardSize-5;
            img.width = 400/board.boardSize-5;
            img.align = 'center';
            king_img.height = 400/board.boardSize-5;
            king_img.width = 400/board.boardSize-5;
            king_img.align = 'center';
            for (i=0; i < pieces.length; i++) {
                if (pieces[i].id.indexOf('king') > -1) {
                    pieces[i].appendChild(king_img.cloneNode(true));
                }
                else {
                    pieces[i].appendChild(img.cloneNode(true));
                }
            }
        }

        var allPieces = document.getElementsByClassName("square1");
        var newBlack = makeNewPiecesList('black');
        var newRed = makeNewPiecesList('red')

        // NEW NEW 
        function makeNewPiecesList(color) {
            var output = []
            for (i = 0; i < allPieces.length; i++) {
                var row_info = 'row'.concat(row);
                var col_info = 'col'.concat(column)
                if (allPieces[i].getAttribute('id').indexOf(row_info) > -1 && allPieces[i].getAttribute('id').indexOf(col_info) > -1 && allPieces[i].getAttribute('id').indexOf(color) > -1) {
                } else if (allPieces[i].getAttribute('id').indexOf(color) > -1) {
                    output.push(allPieces[i]);
                }
            }
            return output;
        }

        addPieces(newBlack,'black');
        addPieces(newRed, 'red');

        //////// DRAW THE ARROW ///////////
        function canvas_arrow(context, fromx, fromy, tox, toy){
            var headlen = 8;   // length of head in pixels
            var angle = Math.atan2(toy-fromy,tox-fromx);
            context.moveTo(fromx, fromy);
            context.lineTo(tox, toy);
            context.lineTo(tox-headlen*Math.cos(angle-Math.PI/6),toy-headlen*Math.sin(angle-Math.PI/6));
            context.moveTo(tox, toy);
            context.lineTo(tox-headlen*Math.cos(angle+Math.PI/6),toy-headlen*Math.sin(angle+Math.PI/6));
        }
        var canvas = document.getElementById("myCanvas");
        var ctxt = canvas.getContext('2d');
        ctxt.clearRect(0, 0, canvas.width, canvas.height);
        ctxt.strokeStyle = '#ff0';
        ctxt.lineWidth   = 2;
        ctxt.beginPath();
        var oneSquare = 400/board.boardSize;
        var distance = (board.currentSpot[0] - board.lastSpot[0], board.currentSpot[1] - board.lastSpot[1])
        ///NEW ENEW
        canvas_arrow(ctxt, (board.lastSpot[0]+0.5)*oneSquare,(board.lastSpot[1]+0.5)*oneSquare, (board.currentSpot[0]+0.5)*oneSquare, (board.currentSpot[1]+0.5)*oneSquare)
        ctxt.stroke();

    }

    // This allows the Javascript code inside this block to only run when the page
    // has finished loading in the browser.
    $(document).ready(function() {

        if ($.getUrlVar('size') && $.getUrlVar('size') >= 6) {
            board = new Board($.getUrlVar('size'));
        } else {
            board = new Board(DEFAULT_BOARD_SIZE);
        }


        rules = new Rules(board);


        // Your code here

        board.addEventListener('add',function (e) {
            // Your code here
        },true);

        board.addEventListener('move',function (e) {
            // Your code here
        },true);

        board.addEventListener('remove', function(e) {
            // Your code here
        }, true);

        board.addEventListener('promote',function (e) {
            // Your code here
        },true);

        
        $("#btnNewGame").click(function(evt) {
            board.prepareNewGame();
            board.lastSpot = [-1,-1];
            board.currentSpot = [-1,-1];
            turn = true;
            // Empty stacks
            rules.ramStack = []
            rules.redoStack = []
            toggleTurn();

        });

        $("#btnAutoMove").click(function(evt) {
          var playerColor = whoseTurn;
          var playerDirection = directionOf(playerColor);
          var result = rules.makeRandomMove(playerColor, playerDirection);
          if (result != null) {
            // Clear redo stack
            rules.redoStack = []

            toggleTurn();
          }
        });

        $("#btnUndo").click(function(evt) {
          var last = rules.ramStack[rules.ramStack.length-1]
          // Removed checkers
          if (last.remove.length != 0) {
            for (i=0;i < last.remove.length; i++) {
                board.add(last.remove[i],last.remove[i].row,last.remove[i].col);
            }
          }
          // For redo
          rules.redoStack.push(rules.ramStack.pop());

          fromRow = last.to_row
          fromCol = last.to_col
          toRow = last.from_row
          toCol = last.from_col
          var playerDirection = directionOf(whoseTurn);
          board.moveTo(board.getCheckerAt(fromRow,fromCol), toRow, toCol);
        // King-making
          if (last.made_king) {
            board.getCheckerAt(toRow,toCol).isKing = false;
          }
          toggleTurn();

          // Grey box edit
          row = -1;
          column = -1;
          populateBoard();
        });

        $("#btnRedo").click(function(evt) {
          var last = rules.redoStack[rules.redoStack.length-1]
          // Removed checkers
          if (last.remove.length != 0) {
            for (i=0;i < last.remove.length; i++) {
                board.remove(last.remove[i]);
            }
          }

          rules.ramStack.push(rules.redoStack.pop());
          fromRow = last.from_row
          fromCol = last.from_col
          toRow = last.to_row
          toCol = last.to_col
          var playerDirection = directionOf(whoseTurn);
          board.moveTo(board.getCheckerAt(fromRow,fromCol), toRow, toCol);
          toggleTurn();
        });


        board.prepareNewGame();
        // MY CODE BELOW
        populateBoard(board.getAllCheckers());

        /////////// MOUSE EVENT HANDLING //////////////
        var clicking = false;

        // For mousemove image
        var color = 'none'
        var draggable = false;

        function canvasMousedown() {
            ///// SETUP FOR OTHER METHODS
            clicking = true;

            //// GET THE CHECKERBOARD INDEX
            // Note: both of these are zero-indexed
            row = Math.floor((event.clientY-5)/(400/board.boardSize))

            column = Math.floor((event.clientX-95)/(400/board.boardSize))-1

            // For mousemove image
            if (!board.getCheckerAt(row,column)) {
                color = 'none';
                return;
            }
            color = board.getCheckerAt(row,column).color
            isKing = board.getCheckerAt(row,column).isKing
            if (color == whoseTurn) {
                draggable = true;
            }
            else {
                draggable = false;
            }
        }

        function canvasMouseup() {
            // For dragging off screen fix
            populateBoard();

            clicking = false;
            var toRow = Math.floor((event.clientY-5)/(400/board.boardSize))

            var toColumn = Math.floor((event.clientX-95)/(400/board.boardSize))-1

            var playerColor = whoseTurn;
            var playerDirection = directionOf(playerColor);
            var turnDirection = playerDirection;
            if (board.isEmptyLocation(row,column)) {
                return
            }
            var result = rules.makeMove(board.getCheckerAt(row,column),turnDirection,playerDirection,toRow,toColumn)
            if (result != null) {
                rules.ramStack.push(result);
                // Clear redo stack
                rules.redoStack = []

                toggleTurn();
            } else {
                // Grey box edit
                row = -1;
                column = -1;
                // end grey box edit
                populateBoard();
            }

        }

        function canvasMousemove() {
            // Clear image
            if (clicking == false) return;
            if (draggable == false) return;
            populateBoard();

            // Draw the checker image
            var img = document.createElement('img');
            img.className = 'checker_image';
            if (color == 'black' && isKing) {
                img.src = 'graphics/black-king.png';
            }
            else if (color == 'black' && !isKing) {
                img.src = 'graphics/black-piece.png';
            }
            else if (color == 'red' && isKing) {
                img.src = 'graphics/red-king.png';
            }
            else if (color == 'red' && !isKing) {
                img.src = 'graphics/red-piece.png';
            }
            else if (color == 'none') {
                img.src = '';
            }
            img.height = 400/board.boardSize-5;
            img.width = 400/board.boardSize-5;

            ctx.drawImage(img,event.clientX-175,event.clientY-35, img.height, img.width)
        }
        // NOTE: the canvas is what is getting clicked
        var canvas = document.getElementById("myCanvas");
        var ctx = canvas.getContext("2d");
        canvas.addEventListener("mousedown", canvasMousedown)
        canvas.addEventListener("mouseup", canvasMouseup)
        canvas.addEventListener("mousemove", canvasMousemove)

    });
</script>

</body>

</html>
