<!DOCTYPE html>

<!--
  Alec Anderson, Alex Latham, Emanuele Ceccarelli, Vineel Chakradhar (listed reluctantly)
-->
<html>

<head>
<meta charset="UTF-8">
<title>eFormations</title>

<!-- Load style sheets -->
<link rel="stylesheet" href="mainLayout.css" />
</head>

<body>

<!-- TODO we could do this using divs if the exact pixel spacing is an issue...-->
<table id="mainTable">
    <table id="mainMenu">
        <td>
            Menu is here
        <td>
    </table>
    <table>
            <div id = "middle" style = "width:100%">
                <div id ="formationWindow" style = "float:left; width: 19%; height: 600px;">
                    <div id="formations">
                    </div>
                </div>
                <div id = "centerWindow" style = "float:left; width: 60%; height: 600px;">
                    <div id="dancerWindow" style = "height: 85%; width: 100%;"> 
                        
                    </div>
                    <div id="centerNotesWindow" style = "height: 15%; width: 100%;">
                        Notes here
                    </div>
                </div>
                <div id = "rosterWindow" style = "float:left; width: 20%; height: 600px;">
                    <!-- Roster window here -->
                </div>
            </div>
    </table>
    <table id="musicWindow" style="width: 100%; height: 100px">
        <td style="clear: left;">
            Music window here
        </td>
    </table>

</table>


<!-- Load any supplemental Javascript libraries here -->
<script type="text/javascript" src="external_js/jquery-1.9.0.min.js"></script>
<script type="text/javascript" src="backend.js"></script>

<script type="text/javascript">
//This script extracts parameters from the URL
//from jquery-howto.blogspot.com
    // $.extend({
    //     getUrlVars : function() {
    //         var vars = [], hash;
    //         var hashes = window.location.href.slice(
    //                 window.location.href.indexOf('?') + 1).split('&');
    //         for ( var i = 0; i < hashes.length; i++) {
    //             hash = hashes[i].split('=');
    //             vars.push(hash[0]);
    //             vars[hash[0]] = hash[1];
    //         }
    //         return vars;
    //     },
    //     getUrlVar : function(name) {
    //         return $.getUrlVars()[name];
    //     }
    // });

    // This allows the Javascript code inside this block to only run when the page
    // has finished loading in the browser.
    
    function addDancerToRosterWindow(dancer) {
        // var forDiv = '<div id=dancer1> <div style="float: left; width: 35%; text-align: left;"> Name </div> <div style="float: left; width: 45%;"> Picture </div> <div style="float: left; width: 20%;"> <button type="button"> + </button> </div>  <br style="clear: left;" /> <div id=editInfoButton> <button type="button"> Edit Info </button> </div>';
        var forDiv = '<div id=dancer1> <div style="float: left; width: 45%; text-align: left;">'.concat(dancer.firstName, " ", dancer.lastName).concat('</div> <div style="float: left; width: 35%;">').concat(dancer.profilePicture).concat('</div> <div style="float: left; width: 20%;"> <button type="button"> + </button> </div>  <br style="clear: left;" /> <div id=editInfoButton> <button type="button"> Edit Info </button> </div>');
        // var forDiv = "<div id=dancer1>
        //     </div>"
        $('#rosterWindow').append(forDiv);

    }
    function loadRosterWindow() {
        // Make Dancers
        var newDancer = new Dancer("Alec", "Anderson", "boy", "src", "total scrub", "circle")
        // console.log(newDancer)
        // addDancerObject(newDancer.shapeOf)
        // 
        addDancerToRosterWindow(newDancer);
        }
    $(document).ready(function() {
        var audio = new Audio('19ManOfTheYear.mp3');
        //audio.play();
        // Loads on page load

        /// Alec messing around with back end
        // var newDancer = new Dancer("Alec", "Anderson", "src", "total scrub", "circle")
        // console.log(newDancer)
        // addDancerObject(newDancer.shapeOf)
        loadRosterWindow();
        // End Alec messing around with back end

        //Varaibles for dragging
        var _startX = 0;            // mouse starting positions
        var _startY = 0;
        var _offsetX = 0;           // current element offset
        var _offsetY = 0;
        var _topZ = 10;
        var _dragElement;           // to store target of mousedown (what's being dragged)
        
        //We will need to maintain some mapping of dancer names to their associated objects. 
        formations = [];
        canvases = [];
        directory = [];

        //Formation sidebar code:

        function editFormation(index, listOfDancers){
            directory[index] = listOfDancers;
            var formation = formations[index];
            formation.removeChild(formation.childNodes[0]);
            var new_canvas = document.createElement("CANVAS");
            // var existingForms = $(".formation").length;
            // $(new_formation).attr("id", );
            $(new_canvas).addClass("forcanvas");
            formation.appendChild(new_canvas);
            canvases[index] = new_canvas;
            var brect = new_canvas.getBoundingClientRect();
            sizex = brect.width;
            sizey = brect.height;


            function loadImages(listOfDancers, callback) {
                var images = {};
                var loadedImages = 0;
                var numImages = 0;
                // get num of sources
                for(i = 0; i< listOfDancers.length;i++) {
                    numImages++;
                }
                for(i = 0; i< listOfDancers.length;i++) {
                    var dancer = listOfDancers[i];
                    images[dancer] = new Image();
                    images[dancer].onload = function() {
                    if(++loadedImages >= numImages) {
                      callback(images);
                    }
                  };
                  images[dancer].src = sources[dancer[0]];
                }
            }
            var context = new_canvas.getContext('2d');

            var sources = {
                'circle': './circle.png',
                'triangle': './triangle.png'
            };

            loadImages(listOfDancers, function(images) {
                for(i = 0; i< listOfDancers.length;i++){
                    image = listOfDancers[i]
                    console.log(image[1])
                    context.drawImage(images[image], image[1]*sizex/100, image[2]*sizey/100, sizex/4, sizey/7);
                }
            });

        }



        function addFormation(listOfDancers) {
            directory.push(listOfDancers);
            var new_formation = document.createElement("div");
            new_formation.addEventListener("click", function(){
                var rec = document.getElementsByClassName("formation");
                for (r in rec){
                    $(rec[r]).removeClass("selected");
                }
                $(new_formation).addClass("selected");

            });
            var new_canvas = document.createElement("CANVAS");
            // var existingForms = $(".formation").length;
            // $(new_formation).attr("id", );
            $(new_canvas).addClass("forcanvas");
            $(new_formation).addClass("formation");
            new_formation.appendChild(new_canvas);
            $("#formations").append(new_formation);
            canvases.push(new_canvas);
            formations.push(new_formation);
            var brect = new_canvas.getBoundingClientRect();
            sizex = brect.width;
            sizey = brect.height;


            function loadImages(listOfDancers, callback) {
                var images = {};
                var loadedImages = 0;
                var numImages = 0;
                // get num of sources
                for(i = 0; i< listOfDancers.length;i++) {
                    numImages++;
                }
                for(i = 0; i< listOfDancers.length;i++) {
                    var dancer = listOfDancers[i];
                    images[dancer] = new Image();
                    images[dancer].onload = function() {
                    if(++loadedImages >= numImages) {
                      callback(images);
                    }
                  };
                  images[dancer].src = sources[dancer[0]];
                }
            }
            var context = new_canvas.getContext('2d');

            var sources = {
                'circle': './circle.png',
                'triangle': './triangle.png'
            };

            loadImages(listOfDancers, function(images) {
                for(i = 0; i< listOfDancers.length;i++){
                    image = listOfDancers[i]
                    console.log(image[1])
                    context.drawImage(images[image], image[1]*sizex/100, image[2]*sizey/100, sizex/4, sizey/7);
                }
            });




            
    
        }
        listOfDancers = [['circle', 165, 212], ['triangle', 314, 350]];
        formationFromList(listOfDancers);
        listOfDancers = [['circle', 50, 50], ['triangle', 30, 35]];
        addFormation(listOfDancers);
        listOfDancers2 = [['circle', 8, 80], ['triangle', 30, 35]];
        editFormation(0,listOfDancers2);

                addFormation(listOfDancers);

        //Takes list of dancers [[shape, style.left, style.top]...], puts them on the dancerWindow
        function formationFromList(dancerList) {
            var bounds = document.getElementById('dancerWindow').getBoundingClientRect();
            for (i = 0; i< listOfDancers.length;i++){
                x = listOfDancers[i];
                obj = addDancerObject(x[0]);

                obj.style.left = x[1] + 'px';
                
                obj.style.top = x[2] + 'px';
                
            }
        }
        
        document.getElementById("dancerWindow").addEventListener("mousedown", OnMouseDown);
        document.getElementById("dancerWindow").addEventListener("mouseup", OnMouseUp);
        // addDancerObject('circle');
        // addDancerObject('triangle');

        
        //Drag function for dancer objects in center pane.
        function OnMouseDown(e)
        {
            var target = e.target;
            
            if ((e.button == 0) && 
                (target.className == 'dancerObject'))  
            {
                
                // grab the mouse position
                _startX = e.clientX;
                _startY = e.clientY;
                
                // grab the clicked element's position
                _offsetX = ExtractNumber(target.style.left);
                _offsetY = ExtractNumber(target.style.top);

                _dragElement = target;

                _dragElement.style.zIndex = ++_topZ;

                document.onmousemove = OnMouseMove;
                return false;
            }
        }

        //Drag function for dancer objects in center pane.
        function OnMouseMove(e)
        {
            if (e == null) {
                var e = window.event; 
            }
            _dragElement.style.left = (_offsetX + e.clientX - _startX) + 'px';
            _dragElement.style.top = (_offsetY + e.clientY - _startY) + 'px'; 
            // _dragElement.style.left = (_offsetX + e.clientX) + 'px';
            // _dragElement.style.top = (_offsetY + e.clientY) + 'px';      
        }
        

        //Drag function for dancer objects in center pane.
        function OnMouseUp(e)
        {
            if (_dragElement != null)
            {
                //Need to check that dragged dancer is within center window
                if (!isInsideDancerWindow(_dragElement)) {
                    _dragElement.style.left = _offsetX + 'px';
                    _dragElement.style.top =  _offsetY + 'px'; 
                }

                document.onmousemove = null;
                _dragElement = null;
            }
        }

        function addDancerObject(shape) {
            var bounds = document.getElementById('dancerWindow').getBoundingClientRect();
            var img = document.createElement('img');
            if (shape == 'circle') {
                img.src = "./circle.png";    
            } else if (shape == 'triangle') {
                img.src = "./triangle.png";
            } else {
                img.src = "./circle.png";    //default shape is circle
            }
            img.className = "dancerObject";
            img.onmousedown = OnMouseDown;
            img.style.left = bounds['left'] + 'px';
            img.style.top = bounds['top'] + 'px';
            document.getElementById("dancerWindow").appendChild(img);
            return img;
        }

        function removeDancerObject(element) {
            element.parentNode.removeChild(element);
        }

        //Helper for drag stuff, gets useful number from element's style
        function ExtractNumber(value) {
            var n = parseInt(value);
            return n == null || isNaN(n) ? 0 : n;
        }

        //Returns true if supplied dancerObj is inside dancerWindow
        function isInsideDancerWindow(dancerObject) {
            var dancer = dancerObject.getBoundingClientRect();
            var bounds = document.getElementById('dancerWindow').getBoundingClientRect();
            return ((dancer['left'] > bounds['left']) && (dancer['right'] < bounds['right']) && (dancer['top'] > bounds['top']) && (dancer['bottom'] < bounds['bottom']))
        }
        });


</script>

</body>

</html>
