<!DOCTYPE html>

<!--
  Alec Anderson, Alex Latham, Emanuele Ceccarelli, Vineel Chakradhar


  Sources Cited: For help with our pop-up (used some elements from this, mostly our own): http://www.formget.com/how-to-create-pop-up-contact-form-using-javascript/
-->
<html>

<head>
<meta charset="UTF-8">
<title>eFormations</title>

<!-- Load style sheets -->
<link rel="stylesheet" href="mainLayout.css" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Josefin+Sans:700italic' rel='stylesheet' type='text/css'>
</head>

<body>

<!-- TODO we could do this using divs if the exact pixel spacing is an issue...-->
<table id="mainTable">
    <table id="mainMenu">
        <td>
            <ul class="drop_menu">
            <li><a href='#'>Roster</a>
                <ul>
                <li><a href='#' onClick="div_show()">View Roster</a></li>
                <li><a href='#' onClick="div_show()">Edit Roster</a></li>
                </ul>
            </li>
            <li><a href='#'>Formations</a>
                <ul>
                <li><a href='#' onClick="$('#btnAdd').click()">Add New Formation</a></li>
                <li><a href='#' onClick="$('#btnDelete').click()">Delete Selected Formation</a></li>
                <li><a href='#' onClick="alert('coming soon!')">Formations Library</a></li>
                </ul>
            </li>
            <li><a href='#'>Transitions</a>
                <ul>
                <li><a href='#' onClick="alert('coming soon!')">Add New Transition</a></li>
                <li><a href='#' onClick="alert('coming soon!')">Visualize Current Transition</a></li>
                </ul>
            </li>
            </ul>
        <td style="padding-top:8px">
            <span class="title" style="font-family: 'Josefin Sans', sans-serif, italic; float:center; position:relative; left:-30%;">eFormations</span>
        </td>
        <td>
        <td align="right">
            <ul class="drop_menu" style="float:right;">
            <li><a href='#'>Welcome, User!</a>
               <!--  <ul style="float: left;">
                <li><span>Logout</span></li>
                </ul>
            </li> -->
        </ul>
        </td>
    </table>
    <table>
            <div id = "middle" style = "width:100%">
                <div id ="formationWindow" style = "float:left; width: 120px; height: 598px;">
                    <div id="formations">
                    </div>
                    <input id="btnAdd" type="button" class="normalBtn" name="new" value="Add"/><br>
                    <input id="btnDelete" type="button" name="delete" class="normalBtn" value="Delete"/>
                    <input id="btnGrid" type="button" name="grid" class="normalBtn" value="Show/Hide Grids"/>

                </div>
                <div id = "centerWindow" style = "float:left; width: 64%; height: 600px;">
                    <div id="dancerWindow" style = "height: 85%; width: 100%;"> 
                        
                    </div>
                    <div id="centerNotesWindow" style = "height: 15%; width: 100%;">
                        <textarea id="notes_text" name="notesText" placeholder="Enter notes here..."></textarea>
                    </div>
                </div>
                <div id = "rosterWindow" style = "overflow: hidden; height: 604px;">
                    <!-- Roster window here -->
                </div>
            </div>
    </table>
    <table id="musicWindow" style="width: 100%; height: 150px">
        <tr id="musicRow" style="text-align: center;">
    <!--         <td>
              <table>

                  <tr><td><input id="btnUpload" type="button" name="new" value="Upload Music File"/></td></tr>
                  <tr><td><input id="btnPlay" disabled type="button" name="new" value="Play"/></td></tr>
                    <tr><td><input id="btnPause" disabled type="button" name="new" value="Pause"/></td></tr>
                    <tr><td><input id="btnRewind" disabled type="button" name="new" value="Rewind"/></td></tr>


                </table>
            </td>

            <td id="content">
                <img width="100%" src="wave.png" hidden id="wave">
            </td> -->
            <td>
                <!-- <input id="btnUpload" type="button" name="new" value="Upload Music File" align="center"/> -->
                <a href="#" class="myButton" id="btnUpload">Upload Music File</a>
            </td>
            <!-- <iframe width="100%" height="150" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/91168184&amp;auto_play=false&amp;hide_related=false&amp;show_comments=true&amp;show_user=true&amp;show_reposts=false&amp;visual=true"></iframe> -->
     <!--        <iframe width="100%" height="150" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/playlists/161540847&amp;auto_play=false&amp;hide_related=false&amp;show_comments=true&amp;show_user=true&amp;show_reposts=false&amp;visual=true"></iframe> -->
        </tr>
    </table>

</table>

<div id="abc" style="z-index: 99999999;">
<!-- Popup Div Starts Here -->
<div id="popupContact">
<!-- Contact Us Form -->
<!-- <form action="#" id="form" method="post" name="form">
<img id="close" src="images/3.png" onclick ="div_hide()">
<h2>Contact Us</h2>
<hr>
<input id="name" name="name" placeholder="Name" type="text">
<input id="email" name="email" placeholder="Email" type="text">
<textarea id="msg" name="message" placeholder="Message"></textarea>
<a href="javascript:%20check_empty()" id="submit">Send</a>
</form> -->
<table id="form">
    <!-- <tr>
        <td> First Name </td>
        <td> Last Name </td>
        <td> Gender </td>
        <td> Profile Picture </td>
        <td> Notes </td>
    </tr>
    <tr>
        <button id="close" onclick="close_popup()"> Save </button>
    </tr> -->
</table>
</div>
<!-- Popup Div Ends Here -->
</div>
<!-- Display Popup Button -->
<!-- <h1>Click Button To Popup Form Using Javascript</h1>
<button id="popup" onclick="div_show()">Popup</button> -->


<!-- Load any supplemental Javascript libraries here -->
<script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
<script type="text/javascript" src="external_js/jquery-1.9.0.min.js"></script>
<script type="text/javascript" src="backend.js"></script>

<script type="text/javascript">
//This script extracts parameters from the URL
//from jquery-howto.blogspot.com
    // $.extend({
    //     getUrlVars : function() {
    //         var vars = [], hash;
    //         var hashes = window.location.href.slice(
    //                 window.location.href.indexOf('?') + 1).split('&');
    //         for ( var i = 0; i < hashes.length; i++) {
    //             hash = hashes[i].split('=');
    //             vars.push(hash[0]);
    //             vars[hash[0]] = hash[1];
    //         }
    //         return vars;
    //     },
    //     getUrlVar : function(name) {
    //         return $.getUrlVars()[name];
    //     }
    // });

    // This allows the Javascript code inside this block to only run when the page
    // has finished loading in the browser.
    
    var overall_dancer_list = new DancerList()
    formationsList = [];
    canvases = [];
    directory = [];
    selected = 0;
    var topDID = 1;
    var topFID = 0;
    var refOriginal;
    var ref;
    var dancersRef;
    var formationsRef;
    var selectorRef;
    var existingFormations = 0;
    var indexToID = {};
    var mydancers = [];
    var popupDancerState = [];

    function menu_add_formation() {

    }

    function urlify(first, last){

        return first.concat(last).toLowerCase();
    }


            function FBinit(){
            refOriginal = new Firebase("https://amber-fire-7704.firebaseio.com");
            sessionNumber = (Math.floor(100000000*Math.random())).toString();

            sessionNumber = "trashCity";
            ref = refOriginal.child(sessionNumber);

            selectorRef = ref.child("selector");
            selectorRef.set(0);

            dancersRef = ref.child("dancers");
            dancersRef.set({});

            mydancers.push("vineelc");
            dancersRef.set({
                vineelc: {
                    first_name: "Vineel",
                    last_name: "C",
                    initials: "VC",
                    formations: {},
                    picture: null,
                    dancerID: 1,
                    gender: "boy",
                    notes: ""
                }
            });     
        
            formationsRef = ref.child("formations");
            formationsRef.set({});
            // formationsRef.child("1").set({
            //     dancers: {},
            //     index: 0,
            //     formationID: 1,
            //     notes: ""
            // });
        }
        FBinit();


    function FBnewDancer(first, last, gender, notes, picture){
            topDID += 1;
            var url = urlify(first, last);
            mydancers.push(url);
            dancersRef.child(url).set({
                
                first_name: first,
                last_name: last,
                initials: first[0].concat(last[0]).toUpperCase(),
                formations: {},
                picture: picture,
                dancerID: topDID,
                gender: gender,
                notes: notes   
            })
        }
        FBnewDancer("Alec", "Andie", "boy", "", null);

        function FBappendFormation(){

            topFID += 1;
            existingFormations += 1;
            indexToID[existingFormations - 1] = topFID.toString();

            formationsRef.child(topFID.toString()).set({
                dancers: {},
                index: existingFormations - 1,
                formationID: topFID,
                notes: ""
            });
        }

        function FBaddDancerToFormation(dancerUrl, formationIndex, x, y){
            formationsRef.child(indexToID[formationIndex]).child("dancers").once("value", function(snapshot){
                if (!snapshot.child(dancerUrl).exists()){
            var initials;
            dancersRef.child(dancerUrl).child("initials").once("value", function(snapshot){
                initials = snapshot.val();
            });
            var gender;
            dancersRef.child(dancerUrl).child("gender").once("value", function(snapshot){
                gender = snapshot.val();
            });           
            dancersRef.child(dancerUrl).child("formations").child(indexToID[formationIndex]).set({
                x: x,
                y: y
            });
            formationsRef.child(indexToID[formationIndex]).child("dancers").child(dancerUrl).set({
                url: dancerUrl,
                gender: gender,
                initials: initials,
                x: x,
                y: y
            });

                }
            })

        }

        function FBsetSelector(index){
            selectorRef.set(index);
        }


        function FBaddDancerToFormationID(dancerUrl, formationID, x, y){
            var initials;
            dancersRef.child(dancerUrl).child("initials").once("value", function(snapshot){
                initials = snapshot.val();
            });
            var gender;
            dancersRef.child(dancerUrl).child("gender").once("value", function(snapshot){
                gender = snapshot.val();
            });       
            dancersRef.child(dancerUrl).child("formations").child(formationID).set({
                x: x,
                y: y
            });
            formationsRef.child(formationID).child("dancers").child(dancerUrl).set({
                gender: gender,
                initials: initials,
                url: dancerUrl,
                x: x,
                y: y
            });
        }

        //functions: addNotesToFormation, retrieveNotes, indexChange, reposition, getPositionsAtFormation

        function FBupdateDancerSpecific(first, last, target, newvalue) {
            var url = urlify(first, last);
            dancersRef.once("value", function(snapshot) {
                if (snapshot.child(url).exists()){
                    dancersRef.child(url).child(target).set(newvalue);
                }
            });
            var k = existingFormations;
            while(k >0){
                k = k-1;
            for (i = 0; i < existingFormations; i++){
                formationsRef.child(indexToID[i]).child("dancers").once("value", function(snapshot){
                    console.log(target)
                        if (snapshot.child(dancerUrl).exists()){
                            console.log("here");
                            formationsRef.child(indexToID[i]).child("dancers").child(dancerUrl).child(target).set(newvalue);
                        }
                });
            }}
        }
        function FBupdateDancer(first, last, gender, notes, picture) {
            FBupdateDancerSpecific(first, last, "gender", gender);
            FBupdateDancerSpecific(first, last, "notes", notes);
            FBupdateDancerSpecific(first, last, "picture", picture);
        }
        function FBremoveFromFormation(dancerUrl, formationIndex){
            formationsRef.child(indexToID[formationIndex]).child("dancers").child(dancerUrl).remove();
            dancersRef.child(dancerUrl).child("formations").child(indexToID[formationIndex]).remove();
        }
        function FBremoveFromRoster(dancerUrl){
            mydancers.splice(mydancers.indexOf(dancerUrl),1);
            dancersRef.child(dancerUrl).remove();
            var k = existingFormations;
            while(k >0){
                k = k-1;
            for (i = 0; i < existingFormations; i++){
                formationsRef.child(indexToID[i]).child("dancers").once("value", function(snapshot){
                        if (snapshot.child(dancerUrl).exists()){
                            formationsRef.child(indexToID[i]).child("dancers").child(dancerUrl).remove();
                        }
                });
            }}
        }

        function FBreplaceDancer(oldDancerUrl, first, last, gender, notes, picture){
            var presences;
            dancersRef.child(oldDancerUrl).once("value", function(snapshot){
                presences = snapshot.val().formations;
            });
            FBremoveFromRoster(oldDancerUrl);
            var newUrl = urlify(first, last);
            FBnewDancer(first, last, gender, notes, picture);
            for (i in presences){
                FBaddDancerToFormationID(newUrl, i, presences[i].x, presences[i].y);
            };
        }

        function FBdeleteFormation(index){
            var ID = indexToID[index];
            formationsRef.child(ID).remove();
            for (dancerUrl in mydancers){
                dancersRef.child(dancerUrl).once("value", function(snapshot) {
                    // alert();
                    // if (snapshot.child("formations").exists()){
                        dancersRef.child(mydancers[dancerUrl]).child("formations").once("value", function(snapshot) {
                            if (snapshot.child(ID).exists()){
                                dancersRef.child(mydancers[dancerUrl]).child("formations").child(ID).remove();
                            // }
                        }
                    });
                });
            }
            for (i=index;i<existingFormations - 1;i++){
                indexToID[i] = indexToID[i+1];
            }
            delete indexToID[existingFormations - 1];
            existingFormations -= 1;
            for (p in indexToID){
                formationsRef.child(indexToID[p]).child("index").set(p);

            }
        }




        
        function FBaddNotesToFormation(notes, index){

            formationsRef.child(indexToID[index]).child("notes").set(notes);
        }

        function FBretrieveNotesFromFormation(index){
            formationsRef.child(indexToID[index]).child("notes").once("value", function(snapshot){
            })

        }

        function FBreposition(dancerUrl, formationIndex, newx, newy, gender, initials){
            dancersRef.child(dancerUrl).child("formations").child(indexToID[formationIndex]).set({
                x: newx,
                y: newy
            });
            formationsRef.child(indexToID[formationIndex]).child("dancers").child(dancerUrl).set({
                url: dancerUrl,
                gender: gender,
                initials: initials,
                x: newx,
                y: newy
            });
        }
        function FBindexchange(oldindex, newindex){
            if (oldindex > newindex){
                var ID = indexToID[oldindex];
                for (i=oldindex; i> newindex; i--){
                    indexToID[i] = indexToID[i-1];
                }
                indexToID[newindex] = ID;
            }
            else if (newindex > oldindex) {
                var ID = indexToID[oldindex];
                for (i=oldindex; i < newindex; i++){
                    indexToID[i] = indexToID[i+1];
                }
                indexToID[newindex] = ID;
            }
            for (p in indexToID){
                formationsRef.child(indexToID[p]).child("index").set(p);

            }
        }


        function FBgetStateAtFormation(index){
            var s;
            formationsRef.child(indexToID[index]).child("dancers").once("value", function(snapshot){
                s = (snapshot.val());
            });
            return s;
        }



    //Function To Display Popup
    function div_show() {
    document.getElementById('abc').style.display = "block";
    }
    //Function to Hide Popup
    function div_hide(){
    document.getElementById('abc').style.display = "none";
    }

    function close_popup() {
        var newContent = {};
        var ctt = 0;
        var a = document.getElementById('form').rows;
        for (r in a){
            if (r != "length" && r != "item" && r != "namedItem"){
                if (a[r].getAttribute("class") == "tabledancer"){
                    var rowid = ctt;
                    ctt += 1;
                    var fn;
                    var ln;
                    var gd;
                    var ns;
                    var cols = a[r].getElementsByTagName("td");
                    for (c in cols){
                        if (c != "length" && c != "item" && c != "namedItem") {
                            var myItem = cols[c].childNodes[0];
                            if (myItem.getAttribute("class") == "firstname"){
                                fn = $(myItem)[0].value;
                            } else if (myItem.getAttribute("class") == "lastname"){
                                ln = $(myItem)[0].value;
                            } else if (myItem.getAttribute("class") == "selectgender"){
                                gd = $(myItem)[0].value;
                            } else if (myItem.getAttribute("class") == "dancernotes"){
                                ns = $(myItem)[0].value;
                            }
                        }
                    }
                    newContent[rowid] = [fn, ln, gd, ns];
                }
            }
        }
        for (id in newContent){
            var fn = newContent[id][0];
            var ln = newContent[id][1];
            var gd = newContent[id][2];
            var ns = newContent[id][3];
            var newUrl = urlify(fn, ln);
            console.log(newUrl);
            console.log(popupDancerState);
            console.log(id)
            if (id >= popupDancerState.length){
                console.log("k")
                FBnewDancer(fn, ln, gd, ns, null);
            }
            else if (newUrl == popupDancerState[id]){
                                console.log("kl")

                FBupdateDancer(fn, ln, gd, ns, null);
            } else {
                                console.log("kgjy")

                FBreplaceDancer(popupDancerState[id], fn, ln, gd, ns, null);
            }
        }
        // var table = document.getElementById('form');
        // for (var i=1;i<(table.rows.length-5);i++) {
        //     var cur_uid = table.rows[i].id
        //     alert(cur_uid)
        //     var cur_fname = table.rows[i].cells[0].innerHTML.text
        //     alert(cur_fname)
        // }


        // overall_dancer_list.list = []
        // $("#form tr.tabledancer").each(function() {
        //     var fName = $(this).find("input.firstname").val()
        //     alert(fName)
        //     var lName = $(this).find("input.lastname").val()
        //     alert(lName)
        //     var newGender = $(this).find("input.selectgender option:selected").text()
        //     alert(newGender)
        //     var profPic = $(this).find("input.profilepic").val()
        //     alert(profPic)
        //     var newNotes = $(this).find("input.dancernotes").val()
        //     alert(newNotes)
        //     var shape = -1
        //     if (newGender == 'girl') { shape = 'triangle'}
        //     else { shape = 'circle'}
        //     alert(shape)
        //     overall_dancer_list.list.push(new Dancer(fName,lName,newGender,profPic,newNotes,shape,null))
        //     });
        // alert(overall_dancer_list.list)
        div_hide();
        // TODO get the information and save to dancerlist
    }

    function other_gender(dancer) {
        if (dancer.gender == "boy") {return "girl"}
        else {return "boy"}
    }

    function makeEmptyPopupRow() {
        var rowindex = document.getElementById('form').rows.length - 3;
        $('#form tr:last').remove();
        $('#form tr:last').remove();
        $('#form').append('<tr class="tabledancer" id="'.concat(rowindex).concat('"><td><input class="firstname" type="text"> </input></td><td><input class="lastname" type="text"> </input></td><td><select class="selectgender"><option>boy</option><option>girl</option></select></td><td><button class="profilepic" type="button"> Choose Image </button></td><td><textarea class="dancernotes"></textarea></td></tr>'));
        $('#form').append('<tr> <td> <button type="button" onclick="makeEmptyPopupRow()"> + </button> </td> </tr>');
        $('#form').append('<tr><td></td><td></td><td tyle="display: block; text-align: right; margin: auto;"><button id="close" onclick="close_popup()"> Save </button></td></tr>');
        }

    $(document).ready(function() {
        div_hide();

        var audio = new Audio('19ManOfTheYear.mp3');
        $("#btnAdd").click(function(evt) {
            addFormation([]);
        });
        $("#btnDelete").click(function(evt) {
            deleteFormation(selected);
        });
        $("#btnGrid").click(function(evt) {
            if (gridLines == false) {
                addGridLines();
                gridLines = true;
            } else {
                removeGridLines();
                gridLines = false;
            }
        });

        $("#btnPlay").click(function(evt) {
            audio.play();
        });
        $("#btnPause").click(function(evt) {
            audio.pause();
        });
        $("#btnRewind").click(function(evt) {
            audio.currentTime = 0;
        });

        // $("#btnUpload").click(function(evt) {
        //     var playbtn = document.getElementById("btnPlay");
        //     var pausebtn = document.getElementById("btnPause");
        //     var rwbtn = document.getElementById("btnRewind");
        //     var wv = document.getElementById("wave");
        //     $(playbtn).prop('disabled', false);
        //     $(pausebtn).prop('disabled', false);
        //     $(rwbtn).prop('disabled', false);
        //     $(wv).prop('hidden', false);
        // });
        // NEW FILE UPLOADING CODE
        $("#btnUpload").click(function(evt) {
            $('#musicRow').empty();
            $('#musicRow').append('<iframe width="100%" height="150" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/91168184&amp;auto_play=false&amp;hide_related=false&amp;show_comments=true&amp;show_user=true&amp;show_reposts=false&amp;visual=true"></iframe>')
        });
        //audio.play();
        // Loads on page load

        /// Alec messing around with back end
        // var newDancer = new Dancer("Alec", "Anderson", "src", "total scrub", "circle")
        // console.log(newDancer)
        // addDancerObject(newDancer.shapeOf)
        // loadRosterWindow();


        // End Alec messing around with back end
        
        gridLines = false;
        

        //Variables for dragging
        var _startX = 0;            // mouse starting positions
        var _startY = 0;
        var _offsetX = 0;           // current element offset
        var _offsetY = 0;
        var _topZ = 10;
        var _dragElement;           // to store target of mousedown (what's being dragged)
        
        //We will need to maintain some mapping of dancer names to their associated objects. 










        

        

        //Formation sidebar code:

        function deleteFormation(index){
            FBdeleteFormation(index);
            var del = formationsList[index];
            $(del).remove();
            formationsList.splice(index,1);
            canvases.splice(index, 1);
            directory.splice(index, 1);
            if (index <= selected) {
                selected = Math.min(selected, formationsList.length - 1);
            } else {
                selected = selected - 1;
            }
            var new_sel = formationsList[selected];
            $(new_sel).addClass("selected");
            FBsetSelector(selected);

            }


        

        function editFormation(index, listOfDancers){
            directory[index] = listOfDancers;
            var formation = formationsList[index];
            formation.removeChild(formation.childNodes[0]);
            var new_canvas = document.createElement("CANVAS");
            // var existingForms = $(".formation").length;
            // $(new_formation).attr("id", );
            $(new_canvas).addClass("forcanvas");
            formation.appendChild(new_canvas);
            canvases[index] = new_canvas;
            var brect = new_canvas.getBoundingClientRect();
            sizex = 283;
            sizey = 139;


            function loadImages(listOfDancers, callback) {
                var images = {};
                var loadedImages = 0;
                var numImages = 0;
                // get num of sources
                for(i = 0; i< listOfDancers.length;i++) {
                    numImages++;
                }
                for(i = 0; i< listOfDancers.length;i++) {
                    var dancer = listOfDancers[i];
                    images[dancer] = new Image();
                    images[dancer].onload = function() {
                    if(++loadedImages >= numImages) {
                      callback(images);
                    }
                  };
                  images[dancer].src = sources[dancer[0]];
                }
            }
            var context = new_canvas.getContext('2d');

            var sources = {
                'circle': './circle.png',
                'triangle': './triangle.png'
            };

            loadImages(listOfDancers, function(images) {
                for(i = 0; i< listOfDancers.length;i++){
                    image = listOfDancers[i]
                    context.drawImage(images[image], image[1]*sizex/100, image[2]*sizey/100, sizex/5, sizey/5);
                }
            });

        }



        function addFormation(listOfDancers) {
            FBappendFormation();
            directory.push(listOfDancers);
            var new_formation = document.createElement("div");
            new_formation.addEventListener("click", function(e){
                //FBappendFormation();
                var rec = document.getElementsByClassName("formation");
                for (r in rec){
                    $(rec[r]).removeClass("selected");
                }
                $(new_formation).addClass("selected");
                var index = parseInt($(new_formation).attr("id"));
                FBsetSelector(index);
                selected = index;

            });
            var new_canvas = document.createElement("CANVAS");
            var existingForms = $(".formation").length;
            $(new_formation).attr("id", (existingForms).toString());
            $(new_canvas).addClass("forcanvas");
            $(new_formation).addClass("formation");
            new_formation.appendChild(new_canvas);
            $("#formations").append(new_formation);
            canvases.push(new_canvas);
            formationsList.push(new_formation);
            var brect = new_canvas.getBoundingClientRect();
            sizex = 109;
            sizey = 109;
                            var rec = document.getElementsByClassName("formation");
                for (r in rec){
                    $(rec[r]).removeClass("selected");
                }
                $(new_formation).addClass("selected");
                var index = parseInt($(new_formation).attr("id"));
                formationFromList(directory[index]);
                selected = index;
                FBsetSelector(index);


            function loadImages(listOfDancers, callback) {
                var images = {};
                var loadedImages = 0;
                var numImages = 0;
                // get num of sources
                for(i = 0; i< listOfDancers.length;i++) {
                    numImages++;
                }
                for(i = 0; i< listOfDancers.length;i++) {
                    var dancer = listOfDancers[i];
                    images[dancer] = new Image();
                    images[dancer].onload = function() {
                    if(++loadedImages >= numImages) {
                      callback(images);
                    }
                  };
                  images[dancer].src = sources[dancer[0]];
                }
            }
            var context = new_canvas.getContext('2d');

            var sources = {
                'circle': './circle.png',
                'triangle': './triangle.png'
            };

            loadImages(listOfDancers, function(images) {
                for(i = 0; i< listOfDancers.length;i++){
                    image = listOfDancers[i]
                    context.drawImage(images[image], image[1]*sizex/100, image[2]*sizey/100, sizex/4, sizey/7);
                }
            });



            
    
        }
        addFormation([]);
                FBaddDancerToFormation("vineelc",0, 50, 50);
                        FBreplaceDancer("vineelc", "Dicks", "McGee", "boy", "shit", null);


        ref.on("value", function(snapshot){
            systemStateUpdate(snapshot.val());
        });
        function systemStateUpdate(snapshot){
            //get dancer list at main formation
            var selectedIndex = snapshot.selector;
            var mainFormation = snapshot.formations[indexToID[selectedIndex]];
            var dancerList = [];

            if ('dancers' in mainFormation){
                var dancerObjectList = mainFormation.dancers;
                for (k in dancerObjectList){
                    var initials = dancerObjectList[k].initials;
                    var gender = dancerObjectList[k].gender;
                    var x = dancerObjectList[k].x;
                    var y = dancerObjectList[k].y;
                    var url = dancerObjectList[k].url;

                    if (gender == "boy"){
                        dancerList.push(["circle", x, y, initials, url]);
                    } else{
                        dancerList.push(["triangle", x, y, initials, url]);
                    }

                }
            }

            formationFromList(dancerList);

            

            //update all sidebar

            for (l=0; l < existingFormations; l++){
                var targetFormation = snapshot.formations[indexToID[l]];
                if ('dancers' in targetFormation){
                    var dancerObjectList2 = targetFormation.dancers;
                    var dancerList2 = [];
                    for (k in dancerObjectList2){
                        var initials = dancerObjectList2[k].initials;
                        var gender = dancerObjectList2[k].gender;
                        var x = dancerObjectList2[k].x;
                        var y = dancerObjectList2[k].y;
                        var url = dancerObjectList2[k].url;
                        if (gender == "boy"){
                            dancerList2.push(["circle", x, y, initials, url]);
                        } else{
                            dancerList2.push(["triangle", x, y, initials, url]);
                        }

                    }
                    editFormation(l, dancerList2);    
                }

            }

            // make side thing according to roster

            //clear roster bar
            $('#rosterWindow').html('');

            //call copy of funct

            var dancers = new DancerList();
            var count = 0;
            var lll = []
            popupDancerState = [];
            for (dancerUrl in snapshot.dancers){
                popupDancerState.push(dancerUrl);
                count +=1;
                var ddr = snapshot.dancers[dancerUrl];
                var dd;
                if (ddr.gender == "boy"){
                    dd = new Dancer(ddr.first_name, ddr.last_name, ddr.gender, "./profile.png", ddr.notes, "circle", "");
                } else {
                    dd = new Dancer(ddr.first_name, ddr.last_name, ddr.gender, "./profile.png", ddr.notes, "triangle", "");
                }
                lll.push(dd);
                addDancerToRosterWindow(dd, count);
                var mystr = "#button".concat(count.toString());
                $(mystr).attr("urlname", dancerUrl);
                $(mystr).click(function(event) {
                // if (dancer1.added == 0) {
                    // dancer1.shapeObject = addDancerObject(dancer1.shapeOf, "AA","dicksmcgee")
                    // // dancer1.added = 1
                    // update();
                    var permurl = dancerUrl;
                    // console.log($(event.target).attr("urlname"));
                    FBaddDancerToFormation($(event.target).attr("urlname"), selected, 50, 50);
                // }
            });

            }

            

            dancers.list = lll;

            //Function To Display Popup
            $('#form').html('');


            function populatePopupRow(dancer) {
                $('#form').append('<tr class="tabledancer" id="'.concat(dancer.uid).concat('"><td><input class="firstname" type="text" value="'.concat(dancer.firstName).concat('"></input></td><td><input class="lastname" type="text" value="',dancer.lastName,'"> </input></td><td><select class="selectgender"><option>',dancer.gender,'</option><option>',other_gender(dancer),'</option></select></td><td><button class="profilepic" type="button"> Choose Image </button></td><td><textarea class="dancernotes"></textarea></td></tr>')));
            }

            function makePopupTable() {
                $('#form').append('<tr><td> First Name </td><td> Last Name </td> <td> Gender </td><td> Profile Picture </td><td> Notes </td></tr>');
                for (i=0; i<dancers.list.length; i++) {
                    // alert("going")
                    populatePopupRow(dancers.list[i]);
                }
            }
            makePopupTable();
            $('#form').append('<tr> <td> <button type="button" onclick="makeEmptyPopupRow()"> + </button> </td> </tr>');

            $('#form').append('<tr><td></td><td></td><td tyle="display: block; text-align: right; margin: auto;"><button id="close" onclick="close_popup()"> Save </button></td></tr>');
            
        }



        function getCurrentDancers(){
            var windoww = document.getElementById('dancerWindow');
            var currentDancers = windoww.getElementsByClassName("dancerObject");
            var bounds = document.getElementById('dancerWindow').getBoundingClientRect();
            var listr = [];
            for (i = 0; i< currentDancers.length;i++){
                danceritem = [$(currentDancers[i]).attr("shape"),100/bounds.width*(parseFloat(currentDancers[i].style.left) - bounds.left), 100/bounds.height*(parseFloat(currentDancers[i].style.top) - bounds.top),$(currentDancers[i]).attr("initials")];
                listr.push(danceritem);
            }
            return listr;
        }

        function update() {
            //editFormation(selected, getCurrentDancers());
        }





        //Takes list of dancers [[shape, style.left, style.top]...], puts them on the dancerWindow
        function formationFromList(dancerList) {
            document.getElementById("dancerWindow").innerHTML = "";
            if (gridLines) {
                addGridLines();
            }
            var bounds = document.getElementById('dancerWindow').getBoundingClientRect();
            for (i = 0; i< dancerList.length;i++){
                x = dancerList[i];
                obj = addDancerObject(x[0], x[3], x[4]);

                obj.style.left = (x[1]*bounds.width/100 + bounds.left) + 'px';
                obj.style.top = (x[2]*bounds.height/100 +bounds.top) + 'px';
                
            }
        }
        
        document.getElementById("dancerWindow").addEventListener("mousedown", OnMouseDown);
        document.getElementById("dancerWindow").addEventListener("mouseup", OnMouseUp);
        // addDancerObject('circle');
        // addDancerObject('triangle');

        

        function addGridLines(){
            var divs = 4;
            var window = document.getElementById('dancerWindow');
            var bounds = window.getBoundingClientRect();
            grids = []
            for (i=1; i< divs; i++) {
                //vert lines
                var img = document.createElement('img');
                img.src = './vert_grid.png';
                var left = (window.offsetWidth/divs)*i;
                img.style.left = (100*i)/divs +"%";
                img.style.top = '0%';
                img.style.position = 'relative';
                img.height = window.offsetHeight;
                img.className = "gridLine";
                img.style.zIndex = 1;
                img.style.opacity = "0.3";
                //Horiz line

                document.getElementById('dancerWindow').appendChild(img);
               
                
            }

            for (j=1; j< divs; j++) {
                console.log("HORIZ");
                var img_h = document.createElement('img');
                img_h.src = './horiz_grid.png';
                console.log(window.offsetHeight);
                var top_h = ((window.offsetHeight+bounds['top'])/divs)*j;
                //img_h.style.top = (-100*j)/divs +"%";
                img_h.style.top = -top_h+'px';
                img_h.style.left = '0%';
                img_h.style.position = 'relative';
                img_h.style.width = '100%';
                img.style.zIndex = 2;
                img_h.className = "gridLine";

                document.getElementById('dancerWindow').appendChild(img_h);
        }
    }

        function removeGridLines(){

            var container = document.getElementById("dancerWindow");
            var elements = container.getElementsByClassName("gridLine");

            while (elements[0]) {
                elements[0].parentNode.removeChild(elements[0]);
            }
        }






        //Drag function for dancer objects in center pane.
        function OnMouseDown(e)
        {
            var target = e.target;
            var realStartx;
            var realStarty;
            var bounds = document.getElementById('dancerWindow').getBoundingClientRect();
            var dancerUrl;
            
            if ((e.button == 0) && 
                (target.className == 'dancerObject' || target.parentNode.className == 'dancerObject'))  
            {
                
                if (target.parentNode.className == 'dancerObject') {

                    target = target.parentNode;
                    dancerUrl = $(target).attr("url");
                }
                // grab the mouse position
                _startX = e.clientX;
                _startY = e.clientY;
                
                // grab the clicked element's position
                _offsetX = ExtractNumber(target.style.left);
                _offsetY = ExtractNumber(target.style.top);
                realStartx = (_offsetX - bounds.left) *100/bounds.width;
                realStarty = (_offsetY - bounds.top) *100/bounds.height;

                _dragElement = target;

                _dragElement.style.zIndex = ++_topZ;

                document.onmousemove = OnMouseMove;
                document.onmouseup = OnMouseUp;
                return false;
            }
        }

        //Drag function for dancer objects in center pane.
        function OnMouseMove(e)
        {
            if (e == null) {
                var e = window.event; 
            }
            
            _dragElement.style.left = (_offsetX + e.clientX - _startX) + 'px';
            _dragElement.style.top = (_offsetY + e.clientY - _startY) + 'px'; 
            
            // _dragElement.style.left = (_offsetX + e.clientX) + 'px';
            // _dragElement.style.top = (_offsetY + e.clientY) + 'px';      
        }
        

        //Drag function for dancer objects in center pane.
        function OnMouseUp(e)
        {
                        var bounds = document.getElementById('dancerWindow').getBoundingClientRect();
            if (_dragElement != null)
            {
                //Need to check that dragged dancer is within center window
                if (!isInsideDancerWindow(_dragElement)) {
                    _dragElement.style.left = _offsetX + 'px';
                    _dragElement.style.top =  _offsetY + 'px'; 

                }
                var dancerUrl = $(_dragElement).attr("url");
                var shape = $(_dragElement).attr("shape");
                var gender;
                if (shape=="circle"){
                    gender = "boy";
                } else {
                    gender = "girl";
                }
                var initials = $(_dragElement).attr("initials");
                var realEndx = (parseInt(_dragElement.style.left) - bounds.left) *100/bounds.width;
                var realEndy = (parseInt(_dragElement.style.top) - bounds.top) *100/bounds.height;
                FBreposition(dancerUrl, selected, realEndx, realEndy, gender, initials);
                document.onmousemove = null;
                _dragElement = null;
            }
        }

        function addDancerObject(shape, initials, url) {
            var bounds = document.getElementById('dancerWindow').getBoundingClientRect();
            var img = document.createElement('img');
            if (shape == 'circle') {
                img.src = "./circle.png";    
            } else if (shape == 'triangle') {
                img.src = "./triangle.png";
            } else {
                img.src = "./circle.png";    //default shape is circle
            }
            
            $(img).attr("shape", shape);
            img.onmousedown = OnMouseDown;
            
            var div = document.createElement('div');
            div.className = "dancerObject";
            div.appendChild(img);
            var text = document.createTextNode(initials);
            var span = document.createElement('span');
            span.appendChild(text);
            span.style.position = 'absolute';
            if (shape == 'circle') {
                span.style.left = '20px';
                span.style.top = '20px';    
            } else {
                span.style.left = '32px';
                span.style.top = '30px';    
            }
            div.appendChild(span);
            div.onmousedown = OnMouseDown;
            div.style.left = bounds['left'] + 'px';
            div.style.top = bounds['top'] + 'px';
            $(div).attr("url", url);
            $(div).attr("shape", shape);
            $(div).attr("initials", initials);
            document.getElementById("dancerWindow").appendChild(div);

            return div;

        }

        function removeDancerObject(element) {
            element.parentNode.removeChild(element);
        }

        //Helper for drag stuff, gets useful number from element's style
        function ExtractNumber(value) {
            var n = parseInt(value);
            return n == null || isNaN(n) ? 0 : n;
        }

        //Returns true if supplied dancerObj is inside dancerWindow
        function isInsideDancerWindow(dancerObject) {
            var dancer = dancerObject.getBoundingClientRect();
            var bounds = document.getElementById('dancerWindow').getBoundingClientRect();
            return ((dancer['left'] >= bounds['left']) && (dancer['right'] <= bounds['right']) && (dancer['top'] >= bounds['top']) && (dancer['bottom'] <= bounds['bottom']))
        }

        

        /////////////////// DANCER WINDOW ////////////////
        function addDancerToRosterWindow(dancer, buttonNumber) {
            // var forDiv = '<div id=dancer1> <div style="float: left; width: 35%; text-align: left;"> Name </div> <div style="float: left; width: 45%;"> Picture </div> <div style="float: left; width: 20%;"> <button type="button"> + </button> </div>  <br style="clear: left;" /> <div id=editInfoButton> <button type="button"> Edit Info </button> </div>';
            var forDiv = '<div id=dancer1> <div style="float: left; width: 40%; text-align: left;">'.concat(dancer.firstName, " ", dancer.lastName).concat('</div> <div style="float: left; width: 35%;">').concat('<img src="' + dancer.profilePicture + '" style="width:50px;height:50px;">').concat('</div> <div style="float: left; width: 20%;"> <button type="button" style="width:40px; height: 40px;" class=plusBtn id=button').concat(buttonNumber).concat('> + </button> </div>  <br style="clear: left;" /> <div id=editInfoButton > <button type="button" class="normalBtn-edit" onclick=div_show()> Edit Info </button> </div>');
            // var forDiv = "<div id=dancer1>
            //     </div>"
            $('#rosterWindow').append(forDiv);

        }



        function loadRosterWindow() {
            // Make Dancers
            var dancers = new DancerList();
            var dancer1 = new Dancer("Alec", "Andie", "boy", "./profile.png", "total scrub", "circle", "")
            addDancerToRosterWindow(dancer1, 1);
            $('#button1').click(function() {
                // if (dancer1.added == 0) {
                    // dancer1.shapeObject = addDancerObject(dancer1.shapeOf, "AA","dicksmcgee")
                    // // dancer1.added = 1
                    // update();
                    FBaddDancerToFormation("alecandie", selected, 50, 50);
                // }
            })
            //
            // var dancer2 = new Dancer("Alex", "Latham", "boy", "./profile.png", "total scrub", "triangle", "")
            // addDancerToRosterWindow(dancer2, 2);
            // $('#button2').click(function() {
            //     // if (dancer2.added == 0) {
            //         dancer2.shapeObject = addDancerObject(dancer2.shapeOf, "AL")
            //         // dancer2.added = 1
            //         update();
            //     // }
            // })
            // // 
            // var dancer3 = new Dancer("Uele", "Italian", "boy", "./profile.png", "total scrub", "circle", "")
            // addDancerToRosterWindow(dancer3, 3);
            // $('#button3').click(function() {
            //     // if (dancer3.added == 0) {
            //         dancer3.shapeObject = addDancerObject(dancer3.shapeOf, "UI")
            //         // dancer3.added = 1
            //         update();
            //     // }
            // })
            // //
            // var dancer4 = new Dancer("Vineel", "C.", "boy", "./profile.png", "total scrub", "triangle", "")
            // addDancerToRosterWindow(dancer4, 4);
            // $('#button4').click(function() {
            //     // if (dancer4.added == 0) {
            //         dancer4.shapeObject = addDancerObject(dancer4.shapeOf, "VC")
            //         // dancer4.added = 1
            //         update();
            //     // }
            // })
            // //
            // var dancer5 = new Dancer("Another", "One", "boy", "./profile.png", "total scrub", "circle", "")
            // addDancerToRosterWindow(dancer5, 5);
            // $('#button5').click(function() {
            //     // if (dancer5.added == 0) {
            //         dancer5.shapeObject = addDancerObject(dancer5.shapeOf, "AO")
            //         // dancer5.added = 1
            //         update();
            //     // }
            // })

            dancers.list = [dancer1];

            //Function To Display Popup

            function populatePopupRow(dancer) {
                $('#form').append('<tr class="tabledancer" id="'.concat(dancer.uid).concat('"><td><input class="firstname" type="text" value="'.concat(dancer.firstName).concat('"></input></td><td><input class="lastname" type="text" value="',dancer.lastName,'"> </input></td><td><select class="selectgender"><option>',dancer.gender,'</option><option>',other_gender(dancer),'</option></select></td><td><button class="profilepic" type="button"> Choose Image </button></td><td><textarea class="dancernotes"></textarea></td></tr>')));
            }

            function makePopupTable() {
                $('#form').append('<tr><td> First Name </td><td> Last Name </td> <td> Gender </td><td> Profile Picture </td><td> Notes </td></tr>');
                for (i=0; i<dancers.list.length; i++) {
                    // alert("going")
                    populatePopupRow(dancers.list[i]);
                }
            }
            makePopupTable();
            $('#form').append('<tr> <td> <button type="button" onclick="makeEmptyPopupRow()"> + </button> </td> </tr>');
            // $('#popupContact').append('<div style="display: block; text-align: center; margin: auto;"> <button id="close" onclick="close_popup()"> Save </button> </div>');
            // $('#form').append('<tr> <td> <button type="button" onclick="makeEmptyPopupRow()"> + </button> </td> </tr>');
            // $('#form').append('<tr><td><button id="close" onclick="close_popup()"> Save </button></td></tr>');
            // $('#form').append('<tr><td></td><td style="display: block; text-align: center; margin: auto;"> <button type="button" onclick="makeEmptyPopupRow()"> + </button> </td> </tr>');
            $('#form').append('<tr><td></td><td></td><td tyle="display: block; text-align: right; margin: auto;"><button id="close" onclick="close_popup()"> Save </button></td></tr>');
            }
        });


</script>

</body>

</html>
