<!DOCTYPE html>

<!--
  Alec Anderson, Alex Latham, Emanuele Ceccarelli, Vineel Chakradhar (listed reluctantly)


  gfy - vinny
-->
<html>

<head>
<meta charset="UTF-8">
<title>eFormations</title>

<!-- Load style sheets -->
<link rel="stylesheet" href="mainLayout.css" />
</head>

<body>

<!-- TODO we could do this using divs if the exact pixel spacing is an issue...-->
<table id="mainTable">
    <table id="mainMenu">
        <td>
            <ul class="drop_menu">
            <li><a href='#'>Roster</a>
                <ul>
                <li><a href='#'>View Roster</a></li>
                <li><a href='#'>Edit Roster</a></li>
                </ul>
            </li>
            <li><a href='#'>Formations</a>
                <ul>
                <li><a href='#'>Add New Formation</a></li>
                <li><a href='#'>Formations Library</a></li>
                </ul>
            </li>
            <li><a href='#'>Transitions</a>
                <ul>
                <li><a href='#'>Add New Transition</a></li>
                <li><a href='#'>Visualize Current Transition</a></li>
                </ul>
            </li>
            </ul>
        <td>
    </table>
    <table>
            <div id = "middle" style = "width:100%">
                <div id ="formationWindow" style = "float:left; width: 19%; height: 600px;">
                    <div id="formations">
                    </div>
                    <input id="btnAdd" type="button" name="new" value="Add"/>

                </div>
                <div id = "centerWindow" style = "float:left; width: 60%; height: 600px;">
                    <div id="dancerWindow" style = "height: 85%; width: 100%;"> 
                        
                    </div>
                    <div id="centerNotesWindow" style = "height: 15%; width: 100%;">
                        <textarea id="notes_text" name="notesText" placeholder="Enter notes here..."></textarea>
                    </div>
                </div>
                <div id = "rosterWindow" style = "float:left; width: 20%; height: 600px;">
                    <!-- Roster window here -->
                </div>
            </div>
    </table>
    <table id="musicWindow" style="width: 100%; height: 150px">
        <td style="clear: left;">
                          <tr><td><input id="btnUpload" type="button" name="new" value="Upload"/></td></tr>
              <tr><td><input id="btnPlay" disabled type="button" name="new" value="Play"/></td><td><input id="btnPause" disabled type="button" name="new" value="Pause"/></td><td><input id="btnRewind" disabled type="button" name="new" value="Rewind"/></td></tr>
        </td>
        <td style="clear: right;">
            <img width="100%" src="wave.png" hidden id="wave">
        </td>
    </table>

</table>

<div id="abc">
<!-- Popup Div Starts Here -->
<div id="popupContact">
<!-- Contact Us Form -->
<form action="#" id="form" method="post" name="form">
<img id="close" src="images/3.png" onclick ="div_hide()">
<h2>Contact Us</h2>
<hr>
<input id="name" name="name" placeholder="Name" type="text">
<input id="email" name="email" placeholder="Email" type="text">
<textarea id="msg" name="message" placeholder="Message"></textarea>
<a href="javascript:%20check_empty()" id="submit">Send</a>
</form>
</div>
<!-- Popup Div Ends Here -->
</div>
<!-- Display Popup Button -->
<h1>Click Button To Popup Form Using Javascript</h1>
<button id="popup" onclick="div_show()">Popup</button>


<!-- Load any supplemental Javascript libraries here -->
<script type="text/javascript" src="external_js/jquery-1.9.0.min.js"></script>
<script type="text/javascript" src="backend.js"></script>

<script type="text/javascript">
//This script extracts parameters from the URL
//from jquery-howto.blogspot.com
    // $.extend({
    //     getUrlVars : function() {
    //         var vars = [], hash;
    //         var hashes = window.location.href.slice(
    //                 window.location.href.indexOf('?') + 1).split('&');
    //         for ( var i = 0; i < hashes.length; i++) {
    //             hash = hashes[i].split('=');
    //             vars.push(hash[0]);
    //             vars[hash[0]] = hash[1];
    //         }
    //         return vars;
    //     },
    //     getUrlVar : function(name) {
    //         return $.getUrlVars()[name];
    //     }
    // });

    // This allows the Javascript code inside this block to only run when the page
    // has finished loading in the browser.
    
    // Validating Empty Field
    function check_empty() {
    if (document.getElementById('name').value == "" || document.getElementById('email').value == "" || document.getElementById('msg').value == "") {
    alert("Fill All Fields !");
    } else {
    document.getElementById('form').submit();
    alert("Form Submitted Successfully...");
    }
    }
    //Function To Display Popup
    function div_show() {
    document.getElementById('abc').style.display = "block";
    }
    //Function to Hide Popup
    function div_hide(){
    document.getElementById('abc').style.display = "none";
    }

    $(document).ready(function() {
        div_hide();

        var audio = new Audio('19ManOfTheYear.mp3');
        $("#btnAdd").click(function(evt) {
            addFormation([]);
        });
        $("#btnPlay").click(function(evt) {
            audio.play();
        });
        $("#btnPause").click(function(evt) {
            audio.pause();
        });
        $("#btnRewind").click(function(evt) {
            audio.currentTime = 0;
        });

        $("#btnUpload").click(function(evt) {
            var playbtn = document.getElementById("btnPlay");
            var pausebtn = document.getElementById("btnPause");
            var rwbtn = document.getElementById("btnRewind");
            var wv = document.getElementById("wave");
            $(playbtn).prop('disabled', false);
            $(pausebtn).prop('disabled', false);
            $(rwbtn).prop('disabled', false);
            $(wv).prop('hidden', false);
        });
        //audio.play();
        // Loads on page load

        /// Alec messing around with back end
        // var newDancer = new Dancer("Alec", "Anderson", "src", "total scrub", "circle")
        // console.log(newDancer)
        // addDancerObject(newDancer.shapeOf)
        loadRosterWindow();
        // End Alec messing around with back end

        //Varaibles for dragging
        var _startX = 0;            // mouse starting positions
        var _startY = 0;
        var _offsetX = 0;           // current element offset
        var _offsetY = 0;
        var _topZ = 10;
        var _dragElement;           // to store target of mousedown (what's being dragged)
        
        //We will need to maintain some mapping of dancer names to their associated objects. 
        formations = [];
        canvases = [];
        directory = [];
        selected = 0;

        //Formation sidebar code:

        function editFormation(index, listOfDancers){
            console.log(listOfDancers)
            directory[index] = listOfDancers;
            var formation = formations[index];
            formation.removeChild(formation.childNodes[0]);
            var new_canvas = document.createElement("CANVAS");
            // var existingForms = $(".formation").length;
            // $(new_formation).attr("id", );
            $(new_canvas).addClass("forcanvas");
            formation.appendChild(new_canvas);
            canvases[index] = new_canvas;
            var brect = new_canvas.getBoundingClientRect();
            sizex = brect.width;
            sizey = brect.height;


            function loadImages(listOfDancers, callback) {
                var images = {};
                var loadedImages = 0;
                var numImages = 0;
                // get num of sources
                for(i = 0; i< listOfDancers.length;i++) {
                    numImages++;
                }
                for(i = 0; i< listOfDancers.length;i++) {
                    var dancer = listOfDancers[i];
                    images[dancer] = new Image();
                    images[dancer].onload = function() {
                    if(++loadedImages >= numImages) {
                      callback(images);
                    }
                  };
                  images[dancer].src = sources[dancer[0]];
                }
            }
            var context = new_canvas.getContext('2d');

            var sources = {
                'circle': './circle.png',
                'triangle': './triangle.png'
            };

            loadImages(listOfDancers, function(images) {
                for(i = 0; i< listOfDancers.length;i++){
                    image = listOfDancers[i]
                    console.log(image[1])
                    context.drawImage(images[image], image[1]*sizex/100, image[2]*sizey/100, sizex/4, sizey/7);
                }
            });

        }



        function addFormation(listOfDancers) {
            directory.push(listOfDancers);
            var new_formation = document.createElement("div");
            new_formation.addEventListener("click", function(e){
                var rec = document.getElementsByClassName("formation");
                for (r in rec){
                    $(rec[r]).removeClass("selected");
                }
                $(new_formation).addClass("selected");
                var index = parseInt($(new_formation).attr("id"));
                formationFromList(directory[index]);
                selected = index;

            });
            var new_canvas = document.createElement("CANVAS");
            var existingForms = $(".formation").length;
            $(new_formation).attr("id", (existingForms).toString());
            $(new_canvas).addClass("forcanvas");
            $(new_formation).addClass("formation");
            new_formation.appendChild(new_canvas);
            $("#formations").append(new_formation);
            canvases.push(new_canvas);
            formations.push(new_formation);
            var brect = new_canvas.getBoundingClientRect();
            sizex = brect.width;
            sizey = brect.height;


            function loadImages(listOfDancers, callback) {
                var images = {};
                var loadedImages = 0;
                var numImages = 0;
                // get num of sources
                for(i = 0; i< listOfDancers.length;i++) {
                    numImages++;
                }
                for(i = 0; i< listOfDancers.length;i++) {
                    var dancer = listOfDancers[i];
                    images[dancer] = new Image();
                    images[dancer].onload = function() {
                    if(++loadedImages >= numImages) {
                      callback(images);
                    }
                  };
                  images[dancer].src = sources[dancer[0]];
                }
            }
            var context = new_canvas.getContext('2d');

            var sources = {
                'circle': './circle.png',
                'triangle': './triangle.png'
            };

            loadImages(listOfDancers, function(images) {
                for(i = 0; i< listOfDancers.length;i++){
                    image = listOfDancers[i]
                    console.log(image[1])
                    context.drawImage(images[image], image[1]*sizex/100, image[2]*sizey/100, sizex/4, sizey/7);
                }
            });




            
    
        }
        var listOfDancers = [['circle', 50, 12], ['triangle', 34, 35]];
        formationFromList(listOfDancers);
        listOfDancers = [['circle', 50, 50], ['triangle', 30, 35]];
        addFormation(listOfDancers);
        var listOfDancers2 = [['circle', 8, 80], ['triangle', 30, 35]];
        editFormation(0,listOfDancers2);

                addFormation(listOfDancers);




        function getCurrentDancers(){
            var windoww = document.getElementById('dancerWindow');
            var currentDancers = windoww.childNodes;
            var bounds = document.getElementById('dancerWindow').getBoundingClientRect();
            var listr = [];
            for (i = 0; i< currentDancers.length;i++){
                danceritem = [$(currentDancers[i]).attr("shape"),100/bounds.width*(parseFloat(currentDancers[i].style.left) - bounds.left), 100/bounds.height*(parseFloat(currentDancers[i].style.top) - bounds.top)];
                listr.push(danceritem);
            }
            return listr;
        }

        function update() {
            editFormation(selected, getCurrentDancers());
        }

        //Takes list of dancers [[shape, style.left, style.top]...], puts them on the dancerWindow
        function formationFromList(dancerList) {
            console.log(dancerList);
            document.getElementById("dancerWindow").innerHTML = "";
            var bounds = document.getElementById('dancerWindow').getBoundingClientRect();
            for (i = 0; i< dancerList.length;i++){
                x = dancerList[i];
                obj = addDancerObject(x[0]);
                console.log(x[1]);
                obj.style.left = (x[1]*bounds.width/100 + bounds.left) + 'px';
                
                obj.style.top = (x[2]*bounds.height/100 +bounds.top) + 'px';
                
            }
        }
        
        document.getElementById("dancerWindow").addEventListener("mousedown", OnMouseDown);
        document.getElementById("dancerWindow").addEventListener("mouseup", OnMouseUp);
        // addDancerObject('circle');
        // addDancerObject('triangle');

        
        //Drag function for dancer objects in center pane.
        function OnMouseDown(e)
        {
            var target = e.target;
            
            if ((e.button == 0) && 
                (target.className == 'dancerObject'))  
            {
                
                // grab the mouse position
                _startX = e.clientX;
                _startY = e.clientY;
                
                // grab the clicked element's position
                _offsetX = ExtractNumber(target.style.left);
                _offsetY = ExtractNumber(target.style.top);

                _dragElement = target;

                _dragElement.style.zIndex = ++_topZ;

                document.onmousemove = OnMouseMove;
                return false;
            }
        }

        //Drag function for dancer objects in center pane.
        function OnMouseMove(e)
        {
            if (e == null) {
                var e = window.event; 
            }
            _dragElement.style.left = (_offsetX + e.clientX - _startX) + 'px';
            _dragElement.style.top = (_offsetY + e.clientY - _startY) + 'px'; 
            // _dragElement.style.left = (_offsetX + e.clientX) + 'px';
            // _dragElement.style.top = (_offsetY + e.clientY) + 'px';      
        }
        

        //Drag function for dancer objects in center pane.
        function OnMouseUp(e)
        {
            if (_dragElement != null)
            {
                //Need to check that dragged dancer is within center window
                if (!isInsideDancerWindow(_dragElement)) {
                    _dragElement.style.left = _offsetX + 'px';
                    _dragElement.style.top =  _offsetY + 'px'; 
                }

                document.onmousemove = null;
                _dragElement = null;
                update();
            }
        }

        function addDancerObject(shape) {
            var bounds = document.getElementById('dancerWindow').getBoundingClientRect();
            var img = document.createElement('img');
            if (shape == 'circle') {
                img.src = "./circle.png";    
            } else if (shape == 'triangle') {
                img.src = "./triangle.png";
            } else {
                img.src = "./circle.png";    //default shape is circle
            }
            img.className = "dancerObject";
            $(img).attr("shape", shape);
            img.onmousedown = OnMouseDown;
            img.style.left = bounds['left'] + 'px';
            img.style.top = bounds['top'] + 'px';
            document.getElementById("dancerWindow").appendChild(img);

            return img;

        }

        function removeDancerObject(element) {
            element.parentNode.removeChild(element);
        }

        //Helper for drag stuff, gets useful number from element's style
        function ExtractNumber(value) {
            var n = parseInt(value);
            return n == null || isNaN(n) ? 0 : n;
        }

        //Returns true if supplied dancerObj is inside dancerWindow
        function isInsideDancerWindow(dancerObject) {
            var dancer = dancerObject.getBoundingClientRect();
            var bounds = document.getElementById('dancerWindow').getBoundingClientRect();
            return ((dancer['left'] > bounds['left']) && (dancer['right'] < bounds['right']) && (dancer['top'] > bounds['top']) && (dancer['bottom'] < bounds['bottom']))
        }


        /////////////////// DANCER WINDOW ////////////////
        function addDancerToRosterWindow(dancer, buttonNumber) {
            // var forDiv = '<div id=dancer1> <div style="float: left; width: 35%; text-align: left;"> Name </div> <div style="float: left; width: 45%;"> Picture </div> <div style="float: left; width: 20%;"> <button type="button"> + </button> </div>  <br style="clear: left;" /> <div id=editInfoButton> <button type="button"> Edit Info </button> </div>';
            var forDiv = '<div id=dancer1> <div style="float: left; width: 45%; text-align: left;">'.concat(dancer.firstName, " ", dancer.lastName).concat('</div> <div style="float: left; width: 35%;">').concat(dancer.profilePicture).concat('</div> <div style="float: left; width: 20%;"> <button type="button" id=button').concat(buttonNumber).concat('> + </button> </div>  <br style="clear: left;" /> <div id=editInfoButton> <button type="button"> Edit Info </button> </div>');
            // var forDiv = "<div id=dancer1>
            //     </div>"
            $('#rosterWindow').append(forDiv);

        }
        function loadRosterWindow() {
            // Make Dancers
            var dancers = new DancerList();
            var dancer1 = new Dancer("Alec", "Anderson", "boy", "src", "total scrub", "circle", "")
            addDancerToRosterWindow(dancer1, 1);
            $('#button1').click(function() {
                dancer1.shapeObject = addDancerObject(dancer1.shapeOf)
                update();
            })
            //
            var dancer2 = new Dancer("Alex", "Latham", "boy", "src", "total scrub", "triangle", "")
            addDancerToRosterWindow(dancer2, 2);
            $('#button2').click(function() {
                dancer2.shapeObject = addDancerObject(dancer2.shapeOf)
                update();
            })
            // 
            var dancer3 = new Dancer("Uele", "Italian", "boy", "src", "total scrub", "circle", "")
            addDancerToRosterWindow(dancer3, 3);
            $('#button3').click(function() {
                dancer3.shapeObject = addDancerObject(dancer3.shapeOf)
                update();
            })
            //
            var dancer4 = new Dancer("Vineel", "Chakra", "boy", "src", "total scrub", "triangle", "")
            addDancerToRosterWindow(dancer4, 4);
            $('#button4').click(function() {
                dancer4.shapeObject = addDancerObject(dancer4.shapeOf)
                update();
            })
            //
            var dancer5 = new Dancer("Another", "One", "boy", "src", "total scrub", "circle", "")
            addDancerToRosterWindow(dancer5, 5);
            $('#button5').click(function() {
                dancer5.shapeObject = addDancerObject(dancer5.shapeOf)
                update();
            })

            dancers.list = [dancer1,dancer2,dancer3,dancer4,dancer5];

            // For pop-up
            // $('#rosterWindow').append('<a href="#myPopup" data-rel="popup" class="ui-btn ui-btn-inline ui-corner-all">Show Popup</a>')

            // $('#rosterWindow').append('<div data-role="popup" id="myPopup"> <p>This is a simple popup.</p> </div>')
            // var person = prompt("Please enter your name", "Harry Potter");
            // $('.for_canvas').empty();
            // $('#dancerWindow').append('<div class="fadeMe"></div> <p>A bunch of content here..</p>')
            // OpenWindow=window.open("", "newwin", "height=500, width=500"); 
            // OpenWindow.document.write("<html><head><title>Edit Dancers</title></head>");
            // var forPopup = '<button type="button"> button here </button>';
            // Make Table for pop-up
            // var table = OpenWindow.document.createElement("table");
            // table.setAttribute("id","popupTable");
            // $('#popupTable').append('<tr><td>First Name</td><td>Last Name</td>',
            //     '<td>Gender</td><td>Profile Picture</td><td>Notes</td>')
            // for (i=0; i < dancers.list.length(); i++) {
            //     $('#popupTable').append('<tr><td')
            // }
            // var forPopup = $('#popupTable').html();
            // alert(forPopup)
            // var forPopup = '<table><tr><td>First Name</td><td>Last Name</td><td>Gender</td><td>Profile Picture</td><td>Notes</td></tr></table>'
            // table.innerHTML = '<tr><td>First Name</td><td>Last Name</td><td>Gender</td><td>Profile Picture</td><td>Notes</td></tr>';
            // alert($('#popupTable').html())

            // OpenWindow.document.write("<body>",forPopup, "</body></html>");
            // OpenWindow.document.close();
            // self.name="main";
            // $("#dialog").dialog({autoOpen : false, modal : true, show : "blind", hide : "blind"});
            // $("#dialog").dialog("open");
            //Function To Display Popup

            }
        });


</script>

</body>

</html>
